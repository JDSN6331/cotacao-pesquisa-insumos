{% extends 'base.html' %}

{% block content %}
<div class="dashboard-container">



    <!-- Se√ß√£o Vis√£o Geral -->
    <div class="overview-section">
        <h2 class="section-title">
            <i class="fas fa-chart-pie"></i>
            Vis√£o Geral
        </h2>
        <div class="overview-cards">
            <div class="overview-card active" data-type="andamento">
                <div class="card-icon">
                    <i class="fas fa-file-invoice-dollar"></i>
                </div>
                <div class="card-content">
                    <div class="card-number" id="count-andamento">0</div>
                    <div class="card-label">Cota√ß√µes em Andamento</div>
                </div>
            </div>
            <div class="overview-card" data-type="pesquisas">
                <div class="card-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <div class="card-content">
                    <div class="card-number" id="count-pesquisas">0</div>
                    <div class="card-label">Pesquisas em Andamento</div>
                </div>
            </div>
            <div class="overview-card" data-type="finalizadas">
                <div class="card-icon">
                    <i class="fas fa-file-circle-check"></i>
                </div>
                <div class="card-content">
                    <div class="card-number" id="count-finalizadas">0</div>
                    <div class="card-label">Cota√ß√µes Finalizadas</div>
                </div>
            </div>
            <div class="overview-card" data-type="pesquisas-finalizadas">
                <div class="card-icon">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="card-content">
                    <div class="card-number" id="count-pesquisas-finalizadas">0</div>
                    <div class="card-label">Pesquisas Finalizadas</div>
                </div>
            </div>
            <div class="overview-card" data-type="perdidas">
                <div class="card-icon">
                    <i class="fas fa-file-circle-xmark"></i>
                </div>
                <div class="card-content">
                    <div class="card-number" id="count-perdidas">0</div>
                    <div class="card-label">Cota√ß√µes Perdidas</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Se√ß√£o de Conte√∫do Din√¢mico -->
    <div class="content-section">
        <!-- Cota√ß√µes em Andamento (padr√£o) -->
        <div class="content-card active" id="content-andamento">
            <div class="content-header">
                <div class="content-header-top">
                    <div class="content-title">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <h3>Cota√ß√µes em Andamento</h3>
                    </div>
                    <div class="content-status">
                        <i class="fas fa-chart-line"></i>
                        <span>Atualizado h√° 5 minutos</span>
                        <button type="button" class="btn btn-success btn-sm ms-3" id="exportAllAndamento"
                            onclick="exportarTodos('andamento')" disabled>
                            <i class="fas fa-file-excel text-white"></i> Exportar Todos
                        </button>
                    </div>
                </div>
                <div class="panel-filters">
                    <div class="panel-search">
                        <select class="panel-filter-select" id="searchTypeAndamento"
                            onchange="atualizarPlaceholder('andamento')">
                            <option value="todos">Todos</option>
                            <option value="id">ID</option>
                            <option value="matricula">Matr√≠cula</option>
                            <option value="nome">Nome</option>
                        </select>
                        <input type="text" placeholder="Pesquisar..." class="panel-search-input" id="searchAndamento">
                        <button type="button" class="panel-search-btn" onclick="filtrarPainel('andamento')">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="content-table">
                <div class="table-responsive">
                    <table class="table table-hover" id="tabelaAndamento">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllAndamento" class="form-check-input"
                                        onchange="toggleSelectAll('andamento')">
                                </th>
                                <th>ID</th>
                                <th>Data</th>
                                <th>Filial</th>
                                <th>Matr√≠cula</th>
                                <th>Cooperado</th>
                                <th>Valor Total</th>
                                <th>Status</th>
                                <th>Tempo</th>
                                <th>√ölt. Modif.</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="table-pagination">
                    <nav aria-label="Page navigation">
                        <ul class="pagination" id="pagination-list-andamento">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">&lt; Anterior</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Pr√≥ximo &gt;</a>
                            </li>
                        </ul>
                    </nav>
                    <div class="pagination-info" id="pagination-info-andamento">P√°gina 1 de 1</div>
                </div>
            </div>
        </div>

        <!-- Pesquisas de Mercado -->
        <div class="content-card" id="content-pesquisas">
            <div class="content-header">
                <div class="content-header-top">
                    <div class="content-title">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>Pesquisas em Andamento</h3>
                    </div>
                    <div class="content-status">
                        <i class="fas fa-chart-line"></i>
                        <span>Atualizado h√° 5 minutos</span>
                        <button type="button" class="btn btn-success btn-sm ms-3" id="exportAllPesquisas"
                            onclick="exportarTodos('pesquisas')" disabled>
                            <i class="fas fa-file-excel text-white"></i> Exportar Todos
                        </button>
                    </div>
                </div>
                <div class="panel-filters">
                    <div class="panel-search">
                        <select class="panel-filter-select" id="searchTypePesquisas"
                            onchange="atualizarPlaceholder('pesquisas')">
                            <option value="todos">Todos</option>
                            <option value="id">ID</option>
                            <option value="matricula">Matr√≠cula</option>
                            <option value="nome">Nome</option>
                        </select>
                        <input type="text" placeholder="Pesquisar..." class="panel-search-input" id="searchPesquisas">
                        <button type="button" class="panel-search-btn" onclick="filtrarPainel('pesquisas')">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="content-table">
                <div class="table-responsive">
                    <table class="table table-hover" id="tabelaPesquisas">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllPesquisas" class="form-check-input"
                                        onchange="toggleSelectAll('pesquisas')">
                                </th>
                                <th>ID</th>
                                <th>Data</th>
                                <th>Filial</th>
                                <th>Matr√≠cula</th>
                                <th>Cooperado</th>
                                <th>Valor Total</th>
                                <th>Status</th>
                                <th>Tempo</th>
                                <th>√ölt. Modif.</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="table-pagination">
                    <nav aria-label="Page navigation">
                        <ul class="pagination" id="pagination-list-pesquisas">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">&lt; Anterior</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Pr√≥ximo &gt;</a>
                            </li>
                        </ul>
                    </nav>
                    <div class="pagination-info" id="pagination-info-pesquisas">P√°gina 1 de 1</div>
                </div>
            </div>
        </div>

        <!-- Cota√ß√µes Finalizadas -->
        <div class="content-card" id="content-finalizadas">
            <div class="content-header">
                <div class="content-header-top">
                    <div class="content-title">
                        <i class="fas fa-file-circle-check"></i>
                        <h3>Cota√ß√µes Finalizadas</h3>
                    </div>
                    <div class="content-status">
                        <i class="fas fa-chart-line"></i>
                        <span>Atualizado h√° 5 minutos</span>
                        <button type="button" class="btn btn-success btn-sm ms-3" id="exportAllFinalizadas"
                            onclick="exportarTodos('finalizadas')" disabled>
                            <i class="fas fa-file-excel text-white"></i> Exportar Todos
                        </button>
                    </div>
                </div>
                <div class="panel-filters">
                    <div class="panel-search">
                        <select class="panel-filter-select" id="searchTypeFinalizadas"
                            onchange="atualizarPlaceholder('finalizadas')">
                            <option value="todos">Todos</option>
                            <option value="id">ID</option>
                            <option value="matricula">Matr√≠cula</option>
                            <option value="nome">Nome</option>
                        </select>
                        <input type="text" placeholder="Pesquisar..." class="panel-search-input" id="searchFinalizadas">
                        <button type="button" class="panel-search-btn" onclick="filtrarPainel('finalizadas')">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="content-table">
                <div class="table-responsive">
                    <table class="table table-hover" id="tabelaFinalizadas">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllFinalizadas" class="form-check-input"
                                        onchange="toggleSelectAll('finalizadas')">
                                </th>
                                <th>ID</th>
                                <th>Data</th>
                                <th>Filial</th>
                                <th>Matr√≠cula</th>
                                <th>Cooperado</th>
                                <th>Valor Total</th>
                                <th>Status</th>
                                <th>Tempo</th>
                                <th>√ölt. Modif.</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="table-pagination">
                    <nav aria-label="Page navigation">
                        <ul class="pagination" id="pagination-list-finalizadas">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">&lt; Anterior</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Pr√≥ximo &gt;</a>
                            </li>
                        </ul>
                    </nav>
                    <div class="pagination-info" id="pagination-info-finalizadas">P√°gina 1 de 1</div>
                </div>
            </div>
        </div>

        <!-- Pesquisas Finalizadas -->
        <div class="content-card" id="content-pesquisas-finalizadas">
            <div class="content-header">
                <div class="content-header-top">
                    <div class="content-title">
                        <i class="fas fa-clipboard-check"></i>
                        <h3>Pesquisas Finalizadas</h3>
                    </div>
                    <div class="content-status">
                        <i class="fas fa-chart-line"></i>
                        <span>Atualizado h√° 5 minutos</span>
                        <button type="button" class="btn btn-success btn-sm ms-3" id="exportAllPesquisasFinalizadas"
                            onclick="exportarTodos('pesquisas-finalizadas')" disabled>
                            <i class="fas fa-file-excel text-white"></i> Exportar Todos
                        </button>
                    </div>
                </div>
                <div class="panel-filters">
                    <div class="panel-search">
                        <select class="panel-filter-select" id="searchTypePesquisasFinalizadas"
                            onchange="atualizarPlaceholder('pesquisas-finalizadas')">
                            <option value="todos">Todos</option>
                            <option value="id">ID</option>
                            <option value="matricula">Matr√≠cula</option>
                            <option value="nome">Nome</option>
                        </select>
                        <input type="text" placeholder="Pesquisar..." class="panel-search-input"
                            id="searchPesquisasFinalizadas">
                        <button type="button" class="panel-search-btn" onclick="filtrarPainel('pesquisas-finalizadas')">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="content-table">
                <div class="table-responsive">
                    <table class="table table-hover" id="tabelaPesquisasFinalizadas">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllPesquisasFinalizadas" class="form-check-input"
                                        onchange="toggleSelectAll('pesquisas-finalizadas')">
                                </th>
                                <th>ID</th>
                                <th>Data</th>
                                <th>Filial</th>
                                <th>Matr√≠cula</th>
                                <th>Cooperado</th>
                                <th>Valor Total</th>
                                <th>Status</th>
                                <th>Tempo</th>
                                <th>√ölt. Modif.</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="table-pagination">
                    <nav aria-label="Page navigation">
                        <ul class="pagination" id="pagination-list-pesquisas-finalizadas">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">&lt; Anterior</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Pr√≥ximo &gt;</a>
                            </li>
                        </ul>
                    </nav>
                    <div class="pagination-info" id="pagination-info-pesquisas-finalizadas">P√°gina 1 de 1</div>
                </div>
            </div>
        </div>

        <!-- Cota√ß√µes Perdidas -->
        <div class="content-card" id="content-perdidas">
            <div class="content-header">
                <div class="content-header-top">
                    <div class="content-title">
                        <i class="fas fa-file-circle-xmark"></i>
                        <h3>Cota√ß√µes Perdidas</h3>
                    </div>
                    <div class="content-status">
                        <i class="fas fa-chart-line"></i>
                        <span>Atualizado h√° 5 minutos</span>
                        <button type="button" class="btn btn-success btn-sm ms-3" id="exportAllPerdidas"
                            onclick="exportarTodos('perdidas')" disabled>
                            <i class="fas fa-file-excel text-white"></i> Exportar Todos
                        </button>
                    </div>
                </div>
                <div class="panel-filters">
                    <div class="panel-search">
                        <select class="panel-filter-select" id="searchTypePerdidas"
                            onchange="atualizarPlaceholder('perdidas')">
                            <option value="todos">Todos</option>
                            <option value="id">ID</option>
                            <option value="matricula">Matr√≠cula</option>
                            <option value="nome">Nome</option>
                        </select>
                        <input type="text" placeholder="Pesquisar..." class="panel-search-input" id="searchPerdidas">
                        <button type="button" class="panel-search-btn" onclick="filtrarPainel('perdidas')">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="content-table">
                <div class="table-responsive">
                    <table class="table table-hover" id="tabelaPerdidas">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllPerdidas" class="form-check-input"
                                        onchange="toggleSelectAll('perdidas')">
                                </th>
                                <th>ID</th>
                                <th>Data</th>
                                <th>Filial</th>
                                <th>Matr√≠cula</th>
                                <th>Cooperado</th>
                                <th>Valor Total</th>
                                <th>Status</th>
                                <th>Tempo</th>
                                <th>√ölt. Modif.</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="table-pagination">
                    <nav aria-label="Page navigation">
                        <ul class="pagination" id="pagination-list-perdidas">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">&lt; Anterior</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Pr√≥ximo &gt;</a>
                            </li>
                        </ul>
                    </nav>
                    <div class="pagination-info" id="pagination-info-perdidas">P√°gina 1 de 1</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o de Exclus√£o -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Exclus√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja excluir esta cota√ß√£o?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        // Estado de pagina√ß√£o por card (10 itens por p√°gina)
        window.paginacao = {
            andamento: { paginaAtual: 1, totalPaginas: 1, tamanhoPagina: 10 },
            pesquisas: { paginaAtual: 1, totalPaginas: 1, tamanhoPagina: 10 },
            finalizadas: { paginaAtual: 1, totalPaginas: 1, tamanhoPagina: 10 },
            'pesquisas-finalizadas': { paginaAtual: 1, totalPaginas: 1, tamanhoPagina: 10 },
            perdidas: { paginaAtual: 1, totalPaginas: 1, tamanhoPagina: 10 }
        };

        // Storage para dados originais (antes de filtragem)
        window.dadosOriginais = {
            andamento: [],
            pesquisas: [],
            finalizadas: [],
            'pesquisas-finalizadas': [],
            perdidas: []
        };
        // Carregar contadores iniciais
        carregarContadores();

        // Carregar dados iniciais (Cota√ß√µes em Andamento por padr√£o)
        carregarCotacoes('andamento', '#tabelaAndamento tbody');

        // Inicializar status de atualiza√ß√£o
        atualizarStatusAtualizacao();

        // Event listeners para os cards de vis√£o geral
        $('.overview-card').on('click', function () {
            const tipo = $(this).data('type');

            // Atualizar cards ativos
            $('.overview-card').removeClass('active');
            $(this).addClass('active');

            // Atualizar conte√∫do vis√≠vel
            $('.content-card').removeClass('active');
            $('#content-' + tipo).addClass('active');

            // Carregar dados correspondentes
            carregarDadosPorTipo(tipo);

            // Atualizar descri√ß√£o baseada no card selecionado
            atualizarDescricaoCard(tipo);
        });

        // Filtros de status e tipo
        $('#statusFilter, #tipoFilter').on('change', function () {
            const status = $('#statusFilter').val();
            const tipo = $('#tipoFilter').val();
            aplicarFiltros(status, tipo);
        });

        // Atualizar dados a cada 5 minutos
        setInterval(function () {
            carregarContadores();
            const cardAtivo = $('.overview-card.active').data('type');
            if (cardAtivo) {
                carregarDadosPorTipo(cardAtivo);
            }
            atualizarStatusAtualizacao();
        }, 300000); // 5 minutos

        // Atualizar status de atualiza√ß√£o a cada minuto
        setInterval(function () {
            atualizarStatusAtualizacao();
        }, 60000); // 1 minuto

        // Corrigir sobreposi√ß√£o dos dropdowns: elevar a linha ativa
        $(document).on('show.bs.dropdown', '.table .dropdown', function () {
            try {
                $('.table tbody tr').css('z-index', 1);
                $(this).closest('tr').css('position', 'relative').css('z-index', 30000);
            } catch (e) { }
        });
        $(document).on('hide.bs.dropdown', '.table .dropdown', function () {
            try {
                $(this).closest('tr').css('z-index', 1);
            } catch (e) { }
        });

        // Mapeamento de IDs para tipos (usado pelos event listeners)
        const tipoMap = {
            'andamento': 'andamento',
            'pesquisas': 'pesquisas',
            'finalizadas': 'finalizadas',
            'pesquisasfinalizadas': 'pesquisas-finalizadas',
            'perdidas': 'perdidas'
        };

        // Event listener para filtrar em tempo real enquanto digita
        $('.panel-search-input').on('input', function () {
            const tipo = $(this).attr('id').replace('search', '').toLowerCase();
            filtrarPainel(tipoMap[tipo] || tipo);
        });

        // Limpar filtro ao pressionar Escape
        $('.panel-search-input').on('keydown', function (e) {
            if (e.key === 'Escape') {
                $(this).val('');
                const tipo = $(this).attr('id').replace('search', '').toLowerCase();
                filtrarPainel(tipoMap[tipo] || tipo);
            }
        });
    });

    // Fun√ß√£o para carregar contadores
    function carregarContadores() {
        $.ajax({
            url: '/api/dashboard/stats',
            method: 'GET',
            success: function (data) {
                $('#count-andamento').text(data.andamento || 0);
                $('#count-pesquisas').text(data.pesquisas || 0);
                $('#count-finalizadas').text(data.finalizadas || 0);
                $('#count-pesquisas-finalizadas').text(data.pesquisas_finalizadas || 0);
                $('#count-perdidas').text(data.perdidas || 0);
            },
            error: function (error) {
                console.error('Erro ao carregar contadores:', error);
            }
        });
    }

    // Fun√ß√£o para carregar dados por tipo
    function carregarDadosPorTipo(tipo) {
        // Resetar para p√°gina 1 sempre que trocar de card
        if (window.paginacao && window.paginacao[tipo]) {
            window.paginacao[tipo].paginaAtual = 1;
        }
        switch (tipo) {
            case 'andamento':
                carregarCotacoes('andamento', '#tabelaAndamento tbody');
                break;
            case 'pesquisas':
                carregarPesquisas('pesquisa', '#tabelaPesquisas tbody');
                break;
            case 'finalizadas':
                carregarCotacoes('finalizadas', '#tabelaFinalizadas tbody');
                break;
            case 'pesquisas-finalizadas':
                carregarPesquisas('finalizadas', '#tabelaPesquisasFinalizadas tbody');
                break;
            case 'perdidas':
                carregarCotacoes('perdidas', '#tabelaPerdidas tbody');
                break;
        }
    }

    // Fun√ß√£o para atualizar descri√ß√£o dos cards
    function atualizarDescricaoCard(tipo) {
        const descricoes = {
            'andamento': 'Cota√ß√µes que est√£o aguardando resposta dos fornecedores ou em processo de an√°lise.',
            'pesquisas': 'Pesquisas em andamento para an√°lise de pre√ßos e concorr√™ncia.',
            'finalizadas': 'Cota√ß√µes que foram conclu√≠das e liberadas para venda.',
            'pesquisas-finalizadas': 'Pesquisas de mercado que foram conclu√≠das e analisadas.',
            'perdidas': 'Cota√ß√µes que n√£o foram fechadas e foram perdidas para a concorr√™ncia.'
        };

        const descricaoElement = $('.content-card.active .content-description');
        if (descricaoElement.length && descricoes[tipo]) {
            descricaoElement.text(descricoes[tipo]);
        }
    }

    // Fun√ß√£o para atualizar status de atualiza√ß√£o
    function atualizarStatusAtualizacao() {
        const agora = new Date();
        const hora = agora.getHours().toString().padStart(2, '0');
        const minuto = agora.getMinutes().toString().padStart(2, '0');

        $('.content-status span').text('Atualizado √†s ' + hora + ':' + minuto);
    }

    // Fun√ß√£o para carregar cota√ß√µes
    function carregarCotacoes(tipo, targetSelector) {
        $.ajax({
            url: '/api/cotacoes?tipo=' + tipo,
            method: 'GET',
            success: function (data) {
                // Armazenar dados originais
                window.dadosOriginais[tipo] = data;
                renderizarTabelaCotacoes(data, targetSelector, tipo);
                atualizarTotalResultados(data.length, tipo);
            },
            error: function (error) {
                console.error('Erro ao carregar cota√ß√µes:', error);
                renderizarMensagemErro(targetSelector, 'Erro ao carregar cota√ß√µes');
            }
        });
    }

    // Fun√ß√£o para carregar pesquisas
    function carregarPesquisas(status, targetSelector) {
        const tipoStorage = status === 'finalizadas' ? 'pesquisas-finalizadas' : 'pesquisas';
        $.ajax({
            url: '/api/pesquisas/' + status,
            method: 'GET',
            success: function (data) {
                // Armazenar dados originais
                window.dadosOriginais[tipoStorage] = data;
                renderizarTabelaPesquisas(data, targetSelector, status);
                atualizarTotalResultados(data.length, tipoStorage);
            },
            error: function (error) {
                console.error('Erro ao carregar pesquisas:', error);
                renderizarMensagemErro(targetSelector, 'Erro ao carregar pesquisas');
            }
        });
    }

    // Fun√ß√£o para atualizar placeholder baseado no tipo de busca selecionado
    function atualizarPlaceholder(tipo) {
        const searchTypeId = {
            'andamento': 'searchTypeAndamento',
            'pesquisas': 'searchTypePesquisas',
            'finalizadas': 'searchTypeFinalizadas',
            'pesquisas-finalizadas': 'searchTypePesquisasFinalizadas',
            'perdidas': 'searchTypePerdidas'
        };

        const searchInputId = {
            'andamento': 'searchAndamento',
            'pesquisas': 'searchPesquisas',
            'finalizadas': 'searchFinalizadas',
            'pesquisas-finalizadas': 'searchPesquisasFinalizadas',
            'perdidas': 'searchPerdidas'
        };

        const searchType = document.getElementById(searchTypeId[tipo]);
        const searchInput = document.getElementById(searchInputId[tipo]);

        if (searchType && searchInput) {
            const placeholders = {
                'todos': 'Pesquisar...',
                'id': 'Digite o ID...',
                'matricula': 'Digite a matr√≠cula...',
                'nome': 'Digite o nome...'
            };
            searchInput.placeholder = placeholders[searchType.value] || 'Pesquisar...';
            // Aplicar filtro imediatamente quando mudar o tipo
            filtrarPainel(tipo);
        }
    }

    // Fun√ß√£o para filtrar painel (pesquisa e filtro local)
    function filtrarPainel(tipo) {
        // Mapeamento de IDs dos campos
        const searchInputId = {
            'andamento': 'searchAndamento',
            'pesquisas': 'searchPesquisas',
            'finalizadas': 'searchFinalizadas',
            'pesquisas-finalizadas': 'searchPesquisasFinalizadas',
            'perdidas': 'searchPerdidas'
        };

        const searchTypeId = {
            'andamento': 'searchTypeAndamento',
            'pesquisas': 'searchTypePesquisas',
            'finalizadas': 'searchTypeFinalizadas',
            'pesquisas-finalizadas': 'searchTypePesquisasFinalizadas',
            'perdidas': 'searchTypePerdidas'
        };

        const statusFilterId = {
            'andamento': 'statusFilterAndamento',
            'pesquisas': 'statusFilterPesquisas'
        };

        const targetSelector = {
            'andamento': '#tabelaAndamento tbody',
            'pesquisas': '#tabelaPesquisas tbody',
            'finalizadas': '#tabelaFinalizadas tbody',
            'pesquisas-finalizadas': '#tabelaPesquisasFinalizadas tbody',
            'perdidas': '#tabelaPerdidas tbody'
        };

        // Obter valores dos filtros
        const searchInput = document.getElementById(searchInputId[tipo]);
        const searchType = document.getElementById(searchTypeId[tipo]);
        const statusFilter = document.getElementById(statusFilterId[tipo]);

        const query = searchInput ? searchInput.value.trim().toLowerCase() : '';
        const searchTypeValue = searchType ? searchType.value : 'todos';
        const statusValue = statusFilter ? statusFilter.value : '';

        // Obter dados originais
        let dados = window.dadosOriginais[tipo] || [];

        // Aplicar filtro de pesquisa por texto baseado no tipo selecionado
        if (query) {
            dados = dados.filter(item => {
                const id = String(item.id || '').toLowerCase();
                const nome = String(item.nome_cooperado || '').toLowerCase();
                const matricula = String(item.matricula_cooperado || '').toLowerCase();

                switch (searchTypeValue) {
                    case 'id':
                        return id.includes(query);
                    case 'matricula':
                        return matricula.includes(query);
                    case 'nome':
                        return nome.includes(query);
                    case 'todos':
                    default:
                        return id.includes(query) || nome.includes(query) || matricula.includes(query);
                }
            });
        }

        // Aplicar filtro de status (apenas para pain√©is em andamento)
        if (statusValue) {
            dados = dados.filter(item => item.status === statusValue);
        }

        // Resetar pagina√ß√£o
        if (window.paginacao && window.paginacao[tipo]) {
            window.paginacao[tipo].paginaAtual = 1;
        }

        // Renderizar dados filtrados
        const isPesquisa = tipo === 'pesquisas' || tipo === 'pesquisas-finalizadas';
        if (isPesquisa) {
            const status = tipo === 'pesquisas-finalizadas' ? 'finalizadas' : 'pesquisa';
            renderizarTabelaPesquisas(dados, targetSelector[tipo], status);
        } else {
            renderizarTabelaCotacoes(dados, targetSelector[tipo], tipo);
        }

        // Atualizar contagem
        atualizarTotalResultados(dados.length, tipo);

        console.log(`üîç Filtro aplicado em ${tipo}: ${dados.length} resultados`);
    }

    // Fun√ß√£o para renderizar tabela de cota√ß√µes
    function renderizarTabelaCotacoes(cotacoes, targetSelector, tipo) {
        const tbody = $(targetSelector);
        tbody.empty();

        if (cotacoes.length === 0) {
            const colSpan = $(targetSelector).closest('table').find('th').length;
            tbody.html('<tr><td colspan="' + colSpan + '" class="text-center py-3">Nenhuma cota√ß√£o encontrada</td></tr>');
            return;
        }
        // Pagina√ß√£o no frontend
        const estado = window.paginacao[tipo] || { paginaAtual: 1, tamanhoPagina: 10 };
        const inicio = (estado.paginaAtual - 1) * estado.tamanhoPagina;
        const fim = inicio + estado.tamanhoPagina;
        const paginaDados = cotacoes.slice(inicio, fim);

        paginaDados.forEach(function (cotacao) {
            const statusClass = getStatusClass(cotacao.status);
            const row = criarLinhaCotacao(cotacao, statusClass, tipo);
            tbody.append(row);
        });
    }

    // Fun√ß√£o para formatar status (primeira letra mai√∫scula)
    function formatarStatus(status) {
        if (!status) return '-';
        // Capitalizar primeira letra de cada palavra
        const statusFormatado = status.toLowerCase().split(' ').map(word =>
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');

        // Corre√ß√£o espec√≠fica para "Liberado Para Venda" -> "Liberado para Venda"
        if (statusFormatado === 'Liberado Para Venda') {
            return 'Liberado para Venda';
        }

        return statusFormatado;
    }

    // Fun√ß√£o para criar linha de cota√ß√£o
    function criarLinhaCotacao(cotacao, statusClass, tipo) {
        const id = cotacao.id;
        const data = cotacao.data;
        const filial = cotacao.nome_filial;
        const matricula = cotacao.matricula_cooperado || '-';
        const cooperado = cotacao.nome_cooperado;
        const valorTotal = cotacao.valor_total !== null && cotacao.valor_total !== undefined ? formatarMoeda(cotacao.valor_total) : '-';
        const status = formatarStatus(cotacao.status);
        const tempoStatus = cotacao.dias_no_status + 'd';
        const ultimaMod = cotacao.data_ultima_modificacao;

        let acoes = '';
        // Verificar se o status permite edi√ß√£o
        const statusBloqueados = ['Liberado para Venda', 'Cota√ß√£o Perdida'];
        const podeEditar = !statusBloqueados.includes(cotacao.status);

        if (tipo === 'finalizadas') {
            // Cota√ß√µes Finalizadas: Exportar e Ir para Vendas
            acoes = `<div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="true">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportarCotacao(${id})"><i class="fas fa-file-excel"></i> Exportar</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="https://vendascooxupe.lightning.force.com/lightning/n/Criar_Pedido" target="_blank"><i class="fas fa-shopping-cart"></i> Ir para Vendas</a></li>
                        </ul>
                    </div>`;
        } else if (tipo === 'perdidas' || !podeEditar) {
            // Cota√ß√µes Perdidas ou com status bloqueado: apenas Exportar
            acoes = `<div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="true">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportarCotacao(${id})"><i class="fas fa-file-excel"></i> Exportar</a></li>
                        </ul>
                    </div>`;
        } else {
            // Cota√ß√µes em Andamento: Editar, Exportar e Excluir
            acoes = `<div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="true">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/cotacao/${id}"><i class="fas fa-edit"></i> Editar</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportarCotacao(${id})"><i class="fas fa-file-excel"></i> Exportar</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="excluirCotacao(${id})"><i class="fas fa-trash"></i> Excluir</a></li>
                        </ul>
                    </div>`;
        }

        return `<tr>
                    <td>
                        <input type="checkbox" class="form-check-input row-checkbox" data-id="${id}" data-tipo="cotacao" onchange="updateExportButton('${tipo}')">
                    </td>
                    <td>${id}</td>
                    <td>${data}</td>
                    <td>${filial}</td>
                    <td>${matricula}</td>
                    <td>${cooperado}</td>
                    <td>${valorTotal}</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                    <td>${tempoStatus}</td>
                    <td>${ultimaMod}</td>
                    <td>${acoes}</td>
                </tr>`;
    }

    // Fun√ß√£o para renderizar tabela de pesquisas
    function renderizarTabelaPesquisas(pesquisas, targetSelector, status) {
        const tbody = $(targetSelector);
        tbody.empty();

        if (!pesquisas || pesquisas.length === 0) {
            const colSpan = $(targetSelector).closest('table').find('th').length;
            tbody.html('<tr><td colspan="' + colSpan + '" class="text-center py-3">Nenhuma pesquisa encontrada</td></tr>');
            return;
        }
        const tipo = status === 'finalizadas' ? 'pesquisas-finalizadas' : 'pesquisas';
        const estado = window.paginacao[tipo] || { paginaAtual: 1, tamanhoPagina: 10 };
        const inicio = (estado.paginaAtual - 1) * estado.tamanhoPagina;
        const fim = inicio + estado.tamanhoPagina;
        const paginaDados = pesquisas.slice(inicio, fim);

        paginaDados.forEach(function (pesquisa) {
            const row = criarLinhaPesquisa(pesquisa, status);
            tbody.append(row);
        });
    }

    // Fun√ß√£o para criar linha de pesquisa
    function criarLinhaPesquisa(pesquisa, status) {
        const id = pesquisa.id;
        const data = pesquisa.data;
        const filial = pesquisa.nome_filial;
        const matricula = pesquisa.matricula_cooperado || '-';
        const cooperado = pesquisa.nome_cooperado;
        // Calcular valor total da pesquisa (usar valor_cooxupe ou valor_concorrente como refer√™ncia)
        const valorTotal = pesquisa.valor_cooxupe !== null && pesquisa.valor_cooxupe !== undefined ? formatarMoeda(pesquisa.valor_cooxupe) : (pesquisa.valor_concorrente !== null && pesquisa.valor_concorrente !== undefined ? formatarMoeda(pesquisa.valor_concorrente) : '-');
        const statusText = formatarStatus(pesquisa.status);
        const tempoStatus = calcularTempoNoStatus(pesquisa.data_entrada_status);
        const ultimaMod = pesquisa.data_ultima_modificacao;

        let acoes = '';
        // Verificar se o status permite edi√ß√£o
        const statusBloqueados = ['Liberado para Venda', 'Cota√ß√£o Perdida'];
        const podeEditar = !statusBloqueados.includes(pesquisa.status);

        if (status === 'finalizadas' || !podeEditar) {
            // Pesquisas Finalizadas ou com status bloqueado: Exportar e Ir para Vendas
            acoes = `<div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="true">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportarPesquisa(${id})"><i class="fas fa-file-excel"></i> Exportar</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="https://vendascooxupe.lightning.force.com/lightning/n/Criar_Pedido" target="_blank"><i class="fas fa-shopping-cart"></i> Ir para Vendas</a></li>
                        </ul>
                    </div>`;
        } else {
            // Pesquisas em Andamento: Editar, Exportar e Excluir
            acoes = `<div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="true">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/pesquisa/${id}"><i class="fas fa-edit"></i> Editar</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportarPesquisa(${id})"><i class="fas fa-file-excel"></i> Exportar</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="excluirPesquisa(${id})"><i class="fas fa-trash"></i> Excluir</a></li>
                        </ul>
                    </div>`;
        }

        const statusClass = getStatusClass(pesquisa.status);
        return `<tr>
                    <td>
                        <input type="checkbox" class="form-check-input row-checkbox" data-id="${id}" data-tipo="pesquisa" onchange="updateExportButton('${status === 'finalizadas' ? 'pesquisas-finalizadas' : 'pesquisas'}')">
                    </td>
                    <td>${id}</td>
                    <td>${data}</td>
                    <td>${filial}</td>
                    <td>${matricula}</td>
                    <td>${cooperado}</td>
                    <td>${valorTotal}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>${tempoStatus}</td>
                    <td>${ultimaMod}</td>
                    <td>${acoes}</td>
                </tr>`;
    }

    // Fun√ß√£o para renderizar mensagem de erro
    function renderizarMensagemErro(targetSelector, mensagem) {
        const tbody = $(targetSelector);
        const colSpan = $(targetSelector).closest('table').find('th').length;
        tbody.html('<tr><td colspan="' + colSpan + '" class="text-center py-3 text-danger">' + mensagem + '</td></tr>');
    }

    // Fun√ß√£o para atualizar total de resultados
    function atualizarTotalResultados(total, tipo) {
        // Atualiza texto "P√°gina X de N" e re-renderiza os controles
        const estado = window.paginacao[tipo];
        if (!estado) return;
        estado.totalPaginas = Math.max(1, Math.ceil((total || 0) / estado.tamanhoPagina));
        const el = document.getElementById('pagination-info-' + tipo);
        if (el) {
            el.textContent = `P√°gina ${estado.paginaAtual} de ${estado.totalPaginas}`;
        }
        renderizarPaginacao(tipo);
    }

    // Renderiza os bot√µes de pagina√ß√£o b√°sicos (Anterior, n√∫mero atual, Pr√≥ximo)
    function renderizarPaginacao(tipo) {
        const ul = document.getElementById('pagination-list-' + tipo);
        const estado = window.paginacao[tipo];
        if (!ul || !estado) return;
        ul.innerHTML = '';
        // Anterior
        const liPrev = document.createElement('li');
        liPrev.className = 'page-item' + (estado.paginaAtual === 1 ? ' disabled' : '');
        liPrev.innerHTML = '<a class="page-link" href="#">&lt; Anterior</a>';
        liPrev.onclick = function (e) { e.preventDefault(); mudarPagina(tipo, estado.paginaAtual - 1); };
        ul.appendChild(liPrev);
        // N√∫mero atual
        const liAtual = document.createElement('li');
        liAtual.className = 'page-item active';
        liAtual.innerHTML = '<a class="page-link" href="#">' + estado.paginaAtual + '</a>';
        ul.appendChild(liAtual);
        // Pr√≥ximo
        const liNext = document.createElement('li');
        liNext.className = 'page-item' + (estado.paginaAtual >= estado.totalPaginas ? ' disabled' : '');
        liNext.innerHTML = '<a class="page-link" href="#">Pr√≥ximo &gt;</a>';
        liNext.onclick = function (e) { e.preventDefault(); mudarPagina(tipo, estado.paginaAtual + 1); };
        ul.appendChild(liNext);
    }

    // Troca de p√°gina e recarrega os dados para refletir a nova janela
    function mudarPagina(tipo, novaPagina) {
        const estado = window.paginacao[tipo];
        if (!estado) return;
        if (novaPagina < 1 || novaPagina > estado.totalPaginas || novaPagina === estado.paginaAtual) return;
        estado.paginaAtual = novaPagina;
        // Recarregar dados do tipo para aplicar o slice da nova p√°gina
        carregarDadosPorTipo(tipo);
    }

    // Fun√ß√£o para aplicar filtros
    function aplicarFiltros(status, tipo) {
        // Implementar l√≥gica de filtros se necess√°rio
        console.log('Aplicando filtros:', { status, tipo });
    }

    // Fun√ß√£o para mostrar mensagens de feedback
    function mostrarMensagem(mensagem, tipo = 'info') {
        // Remover mensagens anteriores
        $('.mensagem-feedback').remove();

        const classe = tipo === 'success' ? 'alert-success' :
            tipo === 'error' ? 'alert-danger' :
                tipo === 'warning' ? 'alert-warning' : 'alert-info';

        const html = `
            <div class="mensagem-feedback alert ${classe} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 10000; min-width: 300px;">
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'exclamation-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;

        $('body').append(html);

        // Auto-remover ap√≥s 5 segundos
        setTimeout(() => {
            $('.mensagem-feedback').fadeOut(() => {
                $('.mensagem-feedback').remove();
            });
        }, 5000);
    }

    // Fun√ß√µes auxiliares
    function getStatusClass(status) {
        // Normalizar o status para compara√ß√£o (primeira letra mai√∫scula)
        const statusNormalizado = formatarStatus(status);

        // Log para debug
        console.log('üîç getStatusClass:', { original: status, normalizado: statusNormalizado });

        switch (statusNormalizado) {
            case 'An√°lise Comercial':
                return 'status-analise-comercial';
            case 'An√°lise Suprimentos':
                return 'status-analise-suprimentos';
            case 'Liberado para Venda':
                return 'status-liberado';
            case 'Cota√ß√£o Perdida':
                return 'status-perdida';
            case 'Cria√ß√£o':
                return 'status-criacao';
            default:
                console.log('‚ö†Ô∏è Status n√£o reconhecido:', statusNormalizado);
                return 'status-criacao';
        }
    }

    function formatarMoeda(valor) {
        if (valor === null || valor === undefined || isNaN(valor)) return '-';
        const numero = parseFloat(valor);
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(numero);
    }

    function formatarNumero(numero) {
        if (numero === null || numero === undefined) return '-';
        return parseFloat(numero).toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function calcularTempoNoStatus(dataEntrada) {
        if (!dataEntrada) return '-';
        const entrada = new Date(dataEntrada);
        const agora = new Date();
        const diff = Math.floor((agora - entrada) / (1000 * 60 * 60 * 24));
        return diff >= 0 ? diff + ' dias' : '0 dias';
    }

    // Fun√ß√µes de exclus√£o
    function excluirCotacao(id) {
        if (confirm('Tem certeza que deseja excluir esta cota√ß√£o?')) {
            $.ajax({
                url: '/api/cotacao/' + id,
                method: 'DELETE',
                success: function (response) {
                    console.log('Cota√ß√£o exclu√≠da com sucesso:', response);
                    const cardAtivo = $('.overview-card.active').data('type');
                    carregarDadosPorTipo(cardAtivo);
                    carregarContadores();
                    // Mostrar mensagem de sucesso
                    mostrarMensagem('Cota√ß√£o exclu√≠da com sucesso!', 'success');
                },
                error: function (xhr, status, error) {
                    console.error('Erro ao excluir cota√ß√£o:', { xhr, status, error });
                    let mensagemErro = 'Erro ao excluir cota√ß√£o.';

                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        mensagemErro += ' ' + xhr.responseJSON.error;
                    } else if (xhr.status === 404) {
                        mensagemErro = 'Cota√ß√£o n√£o encontrada.';
                    } else if (xhr.status === 403) {
                        mensagemErro = 'Voc√™ n√£o tem permiss√£o para excluir esta cota√ß√£o.';
                    }

                    mostrarMensagem(mensagemErro, 'error');
                }
            });
        }
    }

    function excluirPesquisa(id) {
        if (confirm('Tem certeza que deseja excluir esta pesquisa?')) {
            $.ajax({
                url: '/api/pesquisas/' + id, // Corrigido: usar 'pesquisas' no plural
                method: 'DELETE',
                success: function (response) {
                    console.log('Pesquisa exclu√≠da com sucesso:', response);
                    const cardAtivo = $('.overview-card.active').data('type');
                    carregarDadosPorTipo(cardAtivo);
                    carregarContadores();
                    // Mostrar mensagem de sucesso
                    mostrarMensagem('Pesquisa exclu√≠da com sucesso!', 'success');
                },
                error: function (xhr, status, error) {
                    console.error('Erro ao excluir pesquisa:', { xhr, status, error });
                    let mensagemErro = 'Erro ao excluir pesquisa.';

                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        mensagemErro += ' ' + xhr.responseJSON.error;
                    } else if (xhr.status === 404) {
                        mensagemErro = 'Pesquisa n√£o encontrada.';
                    } else if (xhr.status === 403) {
                        mensagemErro = 'Voc√™ n√£o tem permiss√£o para excluir esta pesquisa.';
                    }

                    mostrarMensagem(mensagemErro, 'error');
                }
            });
        }
    }

    // Event listeners para bot√µes de a√ß√£o
    $(document).on('click', '.btn-exportar', function () {
        const id = $(this).data('id');
        exportarCotacao(id);
    });

    $(document).on('click', '.btn-exportar-pesquisa', function () {
        const id = $(this).data('id');
        exportarPesquisa(id);
    });

    function exportarCotacao(id) {
        $.ajax({
            url: '/api/cotacao/' + id + '/exportar',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    const filename = response.filepath.split('\\').pop();
                    const downloadUrl = '/download/' + filename;

                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    alert('Exporta√ß√£o conclu√≠da com sucesso!');
                } else {
                    alert('Erro ao exportar: ' + (response.error || 'Erro desconhecido'));
                }
            },
            error: function (error) {
                console.error('Erro ao exportar cota√ß√£o:', error);
                alert('Erro ao exportar cota√ß√£o. Por favor, tente novamente.');
            }
        });
    }

    function exportarPesquisa(id) {
        $.ajax({
            url: '/api/pesquisa/' + id + '/exportar',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    const filename = response.filepath.split('\\').pop();
                    const downloadUrl = '/download/' + filename;

                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    alert('Exporta√ß√£o conclu√≠da com sucesso!');
                } else {
                    alert('Erro ao exportar: ' + (response.error || 'Erro desconhecido'));
                }
            },
            error: function (error) {
                console.error('Erro ao exportar pesquisa:', error);
                alert('Erro ao exportar pesquisa. Por favor, tente novamente.');
            }
        });
    }

    // Fun√ß√£o auxiliar para converter tipo para ID (camelCase)
    function tipoToId(tipo) {
        // Converte 'pesquisas-finalizadas' para 'PesquisasFinalizadas'
        return tipo.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('');
    }

    // Fun√ß√£o para alternar sele√ß√£o de todos os itens
    function toggleSelectAll(tipo) {
        const selectAllCheckbox = document.getElementById('selectAll' + tipoToId(tipo));
        const rowCheckboxes = document.querySelectorAll(`#content-${tipo} .row-checkbox`);

        rowCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });

        updateExportButton(tipo);
    }

    // Fun√ß√£o para atualizar o estado do bot√£o Exportar Todos
    function updateExportButton(tipo) {
        const rowCheckboxes = document.querySelectorAll(`#content-${tipo} .row-checkbox`);
        const exportButton = document.getElementById('exportAll' + tipoToId(tipo));
        const selectAllCheckbox = document.getElementById('selectAll' + tipoToId(tipo));

        const checkedBoxes = document.querySelectorAll(`#content-${tipo} .row-checkbox:checked`);

        // Atualizar estado do bot√£o
        if (exportButton) exportButton.disabled = checkedBoxes.length === 0;

        // Atualizar estado do checkbox "Selecionar Todos"
        if (selectAllCheckbox) {
            if (checkedBoxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedBoxes.length === rowCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }
    }

    // Fun√ß√£o para exportar todos os itens selecionados
    function exportarTodos(tipo) {
        const checkedBoxes = document.querySelectorAll(`#content-${tipo} .row-checkbox:checked`);

        if (checkedBoxes.length === 0) {
            alert('Selecione pelo menos um item para exportar.');
            return;
        }

        const ids = Array.from(checkedBoxes).map(checkbox => parseInt(checkbox.dataset.id));
        const tipoItem = checkedBoxes[0].dataset.tipo;

        if (tipoItem === 'cotacao') {
            exportarMultiplasCotacoes(ids);
        } else {
            exportarMultiplasPesquisas(ids);
        }
    }

    // Fun√ß√£o para exportar m√∫ltiplas cota√ß√µes
    function exportarMultiplasCotacoes(ids) {
        $.ajax({
            url: '/api/cotacoes/exportar',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ ids: ids }),
            success: function (response) {
                if (response.success) {
                    const filename = response.filepath.split('\\').pop();
                    const downloadUrl = '/download/' + filename;

                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    alert(`Exporta√ß√£o de ${ids.length} cota√ß√µes conclu√≠da com sucesso!`);
                } else {
                    alert('Erro ao exportar: ' + (response.error || 'Erro desconhecido'));
                }
            },
            error: function (error) {
                console.error('Erro ao exportar cota√ß√µes:', error);
                alert('Erro ao exportar cota√ß√µes. Por favor, tente novamente.');
            }
        });
    }

    // Fun√ß√£o para exportar m√∫ltiplas pesquisas
    function exportarMultiplasPesquisas(ids) {
        $.ajax({
            url: '/api/pesquisas/exportar',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ ids: ids }),
            success: function (response) {
                if (response.success) {
                    const filename = response.filepath.split('\\').pop();
                    const downloadUrl = '/download/' + filename;
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    alert(`Exporta√ß√£o de ${ids.length} pesquisas conclu√≠da com sucesso!`);
                } else {
                    alert('Erro ao exportar: ' + (response.error || 'Erro desconhecido'));
                }
            },
            error: function (error) {
                console.error('Erro ao exportar pesquisas:', error);
                alert('Erro ao exportar pesquisas. Por favor, tente novamente.');
            }
        });
    }
</script>
</div>
{% endblock %}